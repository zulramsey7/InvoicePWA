document.addEventListener('DOMContentLoaded', () => {
  // --- PENGESAHAN LOG MASUK ---
  auth.onAuthStateChanged(user => {
      if (!user) {
          window.location.href = 'index.html';
      } else {
          // Jika pengguna log masuk, muatkan data invois
          loadInvoiceData();
      }
  });

  // --- ELEMEN DOM ---
  const invoiceContainer = document.getElementById('invoice-container');
  const downloadPdfBtn = document.getElementById('download-pdf-btn');

  // --- FUNGSI UNTUK MEMUATKAN DATA INVOIS ---
  async function loadInvoiceData() {
      // Dapatkan ID invois dari URL
      const urlParams = new URLSearchParams(window.location.search);
      const invoiceId = urlParams.get('id');

      if (!invoiceId) {
          invoiceContainer.innerHTML = '<p style="text-align:center; color:red;">Ralat: ID Invois tidak dijumpai.</p>';
          return;
      }

      try {
          const doc = await db.collection('invoices').doc(invoiceId).get();

          if (doc.exists) {
              const invoice = doc.data();
              renderInvoice(invoice);
          } else {
              invoiceContainer.innerHTML = '<p style="text-align:center; color:red;">Ralat: Invois tidak wujud.</p>';
          }
      } catch (error) {
          console.error("Error loading invoice:", error);
          invoiceContainer.innerHTML = '<p style="text-align:center; color:red;">Gagal memuatkan invois.</p>';
      }
  }

  // --- FUNGSI UNTUK MENAMPILKAN KANDUNGAN INVOIS KE DALAMAN HTML ---
  function renderInvoice(invoice) {
      // Format tarikh
      const formatDate = (dateString) => new Date(dateString).toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: '2-digit' });

      // Buat baris jadual untuk butiran butiran
      const itemsRows = invoice.items.map(item => `
          <tr>
              <td>${item.sku || '-'}</td>
              <td>${item.description}</td>
              <td>${item.size || '-'}</td>
              <td>${item.quantity}</td>
              <td>RM ${parseFloat(item.price).toLocaleString('en-MY')}</td>
              <td>RM ${(item.quantity * item.price).toLocaleString('en-MY')}</td>
          </tr>
      `).join('');

      // Buat HTML untuk keseluruhan invois
      invoiceContainer.innerHTML = `
          <header class="invoice-header">
              <div class="invoice-details">
                  <div class="invoice-logo">
                      <img src="${invoice.companyLogo || 'https://via.placeholder.com/150'}" alt="Logo Syarikat">
                  </div>
                  <div class="invoice-details">
                      <h1>INVOIS</h1>
                      <p>No: ${invoice.invoiceNumber}</p>
                      <p>Tarikh: ${formatDate(invoice.date)}</p>
                      <p>Jatuh Tempo: ${formatDate(invoice.dueDate)}</p>
                  </div>
              </div>
          </header>

          <section class="invoice-billings">
              <div class="invoice-billings">
                  <h3>Dari:</h3>
                  <p>${invoice.company.name}</p>
                  <p>${invoice.company.address.replace(/\n/g, '<br>')}</p>
                  <p>${invoice.company.email}</p>
                  <p>${invoice.company.phone}</p>
              </div>
              <div class="invoice-billings">
                  <h3>Kepada:</h3>
                  <p>${invoice.client.name}</p>
                  <p>${invoice.client.address.replace(/\n/g, '<br>')}</p>
              </div>
          </section>

          <table class="invoice-table">
              <thead>
                  <tr>
                      <th>No. Invois</th>
                      <th>Penerangan</th>
                      <th>Saiz</th>
                      <th>Kuantiti</th>
                      <th>Harga (RM)</th>
                      <th>Jumlah (RM)</th>
                  </tr>
              </thead>
              <tbody>
                  ${itemsRows}
              </tbody>
          </table>

          <section class="invoice-summary">
              <div class="invoice-summary">
                  <table>
                      <tr>
                          <td class="label">Jumlah:</td>
                          <td>RM ${parseFloat(invoice.subtotal).toLocaleString('en-MY')}</td>
                      </tr>
                      <tr>
                          <td class="label">Cukai (${invoice.tax}%):</td>
                          <td>RM ${((parseFloat(invoice.subtotal) * (parseFloat(invoice.tax) / 100)).toLocaleString('en-MY')}</td>
                      </tr>
                      <tr>
                          <td class="label">Jumlah Keseluruhan (RM):</td>
                          <td class="total">RM ${parseFloat(invoice.grandTotal).toLocaleString('en-MY')}</td>
                      </tr>
                  </table>
              </div>
          </section>

          <section class="invoice-footer">
              <div class="invoice-footer-notes">
                  <h3>Nota & Terma Pembayaran</h3>
                  <p>${invoice.notes || 'Tiada catatan tambahan.'}</p>
              </div>

              <div class="invoice-footer-payment">
                  <h3>Butiran Pembayaran</h3>
                  <p><strong>Bank:</strong> ${invoice.bankDetails.bankName}</p>
                  <p><strong>Nama Akaun:</strong> ${invoice.bankDetails.accountName}</p>
                  <p><strong>No. Akaun:</strong> ${invoice.bankDetails.accountNumber}</p>
              </div>
          </section>
      `;
  }

  // --- FUNGSI UNTUK MEMUATKAN PDF ---
  function generatePDF() {
      const element = document.getElementById('invoice-container');
  
      // Paparkan mesej loading
      const downloadBtn = document.getElementById('download-pdf-btn');
      const originalIcon = downloadBtn.innerHTML;
      downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menjana...';
      downloadBtn.style.pointerEvents = 'none'; // Lumpuhkan butang semasa proses

      // Gunakan html2canvas untuk menjadikan elemen HTML menjadi imej
      html2canvas(element, {
          scale: 2, // Skala 2x untuk kualiti yang lebih baik
          useCORS: true,
          logging: false,
          onrendered: function (canvas) {
              const imgData = canvas.toDataURL('image/png');
              
              // Gunakan jsPDF untuk mencipta PDF dari imej
              const { jsPDF } = window.jspdf;
              
              // Cipta dokumen PDF baru
              const pdf = new jsPDF({
                  orientation: 'portrait', // 'portrait' atau 'landscape'
                  unit: 'mm', // Unit pengukuran (mm)
                  format: 'a4', // Saiz kertas (A4, A3, dll.)
              });

              // Tambah imej (logo syarikat) ke dalam PDF
              pdf.addImage(imgData, 'PNG', 10, 10, 190, 277); // x, y, lebar, tinggi (dalam mm)

              // Tambah butiran jadual invois
              invoice.items.forEach(item => {
                  pdf.setFontSize(12);
                  pdf.text(16, 20, 'Invois No. ' + item.sku);
                  pdf.text(16, 28, item.description);
                  pdf.text(16, 20, 'Saiz: ' + item.size);
                  pdf.text(16, 20, ` + item.quantity + ' x ' + parseFloat(item.price).toFixed(2));
                  pdf.text(16, 20, 'RM ' + (item.quantity * item.price).toFixed(2));
                  pdf.text(16, 20, '---------------------------');
              });

              // Tambah butiran butiran
              const grandTotal = parseFloat(invoice.grandTotal);
              const taxAmount = (parseFloat(invoice.subtotal) * (parseFloat(invoice.tax) / 100);
              const total = grandTotal + taxAmount;

              pdf.setFontSize(12);
              pdf.text(16, 20, 'Jumlah (RM):');
              pdf.setFontSize(12);
              pdf.text(16, 20, 'RM ' + grandTotal.toFixed(2));

              // Simpan PDF
              pdf.save(`invoice-${invoice.invoiceNumber}.pdf`);
              
              // Kembalikan butang ke keadaan asal
              downloadBtn.innerHTML = originalIcon;
              downloadBtn.style.pointerEvents = 'auto';
          });
  }

  // --- EVENT LISTENER ---
  // Tambahkan event listener untuk butang muat turun PDF
  const downloadPdfBtn = document.getElementById('download-pdf-btn');
  if (downloadPdfBtn) {
      downloadPdfBtn.addEventListener('click', () => {
          generatePDF();
      });
  }
});